[appendix]
== Mobi Security Policies

Mobi utilizes https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=xacml[XACML] standards to support
Attribute-Based Access Control (ABAC). See the ABAC section for more detail.

=== Attribute-Based Access Control

Attribute-Based Access Control is an alternative to the traditional Role-Based Access Control (RBAC) - an authorization
model where users are permitted to access resources based on the roles assigned to the user. As the name implies, ABAC
evaluates a combination of Attributes to determine the user's access permissions.

The base Attributes in Mobi's ABAC model are:

- *Subject*: The subject is the user requesting access to a resource in order to perform an action. These are typically
gathered from a token or an existing database/HR system.
- *Resource*: The resource is an object or asset (e.g., files, records, metadata, application, etc.) that the user wants
to access. Resource attributes in Mobi are typically the IRIs of object.
- *Action*: The action is what the user wants to do with the resource. The typical actions in Mobi are "Create", "Read",
"Update", "Delete", and "Modify".

==== Attribute-Based Access Control Workflow

As an example, a policy in Mobi may state "Only users who have the admin role may view Ontology Record 1." When a
request is made, Mobi's XACML Engine (discussed below) will evaluate the request and grant view permission if the
request has the following attributes:

- Subject is the IRI of the User making the request
- Subject `hasUserRole` of `admin`
- Action is the "Read" action
- Resource is the IRI of Ontology Record 1

=== XACML

eXtensible Access Control Markup Language (XACML) is an XML based language that enables security policy definitions and
request evaluation to determine if a user has access to given resource. It is composed of the following components:

- *Policy Decision Point (PDP)*: Evaluates requests against authorization policies before issuing access decisions
- *Policy Enforcement Point (PEP)*: Intercepts user's access request to a resource, makes a decision request to the PDP
to obtain the access decision
(i.e. access to the resource is approved or rejected), and acts on the received decision
- *Policy Information Point (PIP)*: The system entity that acts as a source of attribute values (i.e. a resource,
subject, environment)
- *Policy Retrieval Point (PRP)*: Point where the XACML access authorization policies are stored, typically a database
or the filesystem.

image::xacml/XACML_Workflow.png[XACML Evaluation Engine]

The XACML specification supports both Attribute-Based Access Control and Role-Based Access Control. Mobi's
implementation of XACML only supports ABAC. Request make to the PEP are evaluated in the PDP and return whether or not
a user can access a Resource based on the ABAC schema defined above.

Mobi's XACML definitions are structured using combinations of the following top level elements:

- *Policy*: contains a set of Rule elements and a specified procedure for combining the results of their evaluation.
It is the basic unit of the policy used by the PDP, and so it is intended to form the basis of an authorization decision
- *Rule*: contains a Boolean expression that can be evaluated in isolation, but that is not intended to be accessed in
isolation by a PDP. A Rule can be comprised of the following sub-elements:
* *Target*: defines the set of requests to which the rule is intended to apply in the form of a logical expression on
attributes in the request.
* *Effect*: indicates the rule-writer's intended consequence of a "True" evaluation for the rule.  Two values are
allowed: "Permit" and "Deny".
* *Condition*: represents a Boolean expression that refines the applicability of the rule beyond the predicates implied
by its target.  Therefore, it may be absent.
* *Obligation Expressions*: An operation specified in a rule, policy or policy set that should be performed by the PEP
in conjunction with the enforcement of an authorization decision.  These are currently unused in Mobi policies.
* *Advice Expressions*: A supplementary piece of information in a policy or policy set which is provided to the PEP with
the decision of the PDP. These are currently unused in Mobi policies.

==== XACML Example

Here is an example policy that is used in Mobi to control what users may create an Ontology Record:
```xml
<Policy xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" PolicyId="http://mobi.com/policies/ontology-creation" RuleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit" Version="1.0">
    <Description>Who can create an OntologyRecord in the Local Catalog?</Description>
    <Target>
        <AnyOf>
            <AllOf>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/catalog-local</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:resource:resource-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/ontologies/policy#Create</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/ontologies/ontology-editor#OntologyRecord</AttributeValue>
                    <AttributeDesignator AttributeId="http://www.w3.org/1999/02/22-rdf-syntax-ns#type" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
            </AllOf>
        </AnyOf>
    </Target>
    <Rule RuleId="urn:createOntologyRecord" Effect="Permit">
        <Target>
            <AnyOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/roles/user</AttributeValue>
                        <AttributeDesignator AttributeId="http://mobi.com/ontologies/user/management#hasUserRole" Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                    </Match>
                </AllOf>
            </AnyOf>
        </Target>
    </Rule>
    <Rule RuleId="urn:createOntologyRecordAdmin" Effect="Permit">
        <Target>
            <AnyOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
                        <AttributeDesignator Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" AttributeId="http://mobi.com/ontologies/user/management#username" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                    </Match>
                </AllOf>
            </AnyOf>
        </Target>
    </Rule>
</Policy>
```

The `Target` of this policy matches requests where:

- The Resource is the Mobi Catalog `http://mobi.com/catalog-local`
- The Action is Create `http://mobi.com/ontologies/policy#Create`
- The Action Attribute for the RDF Type is an Ontology Record `http://mobi.com/ontologies/ontology-editor#OntologyRecord`

Any request that have these 3 criteria are evaluated against the rule section. If either rule resolves to be True, then
the request's response is a `Permit` as defined in the `Effect` field in each `Rule` element.

The first `Rule` states that the user making the request must be a user in Mobi:

- `hasUserRole` (`http://mobi.com/ontologies/user/management#hasUserRole`) of `user` (`http://mobi.com/roles/user`)

The second `Rule` states that the user must be the `admin` user:

- `username` (`http://mobi.com/ontologies/user/management#username`) must equal `admin`

These match operator is defined by the `MatchId` field of the `Match` element. Most Mobi policies use the basic `equals`
operator `urn:oasis:names:tc:xacml:1.0:function:string-equal`. See the
http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html#_Toc325047234[XACML Functions] section of the
specification to see other possible operations.

==== XACML Workflow

Let's modify our previous example to only allow the `admin` user to create Ontology Records by deleting the `Rule` with
the `hasUserRole` section. Our new modified policy now looks like this:

```xml
<Policy xmlns="urn:oasis:names:tc:xacml:3.0:core:schema:wd-17" PolicyId="http://mobi.com/policies/ontology-creation" RuleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit" Version="1.0">
    <Description>Who can create an OntologyRecord in the Local Catalog?</Description>
    <Target>
        <AnyOf>
            <AllOf>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/catalog-local</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:resource:resource-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:resource" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/ontologies/policy#Create</AttributeValue>
                    <AttributeDesignator AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
                <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                    <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">http://mobi.com/ontologies/ontology-editor#OntologyRecord</AttributeValue>
                    <AttributeDesignator AttributeId="http://www.w3.org/1999/02/22-rdf-syntax-ns#type" Category="urn:oasis:names:tc:xacml:3.0:attribute-category:action" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                </Match>
            </AllOf>
        </AnyOf>
    </Target>
    <Rule RuleId="urn:createOntologyRecordAdmin" Effect="Permit">
        <Target>
            <AnyOf>
                <AllOf>
                    <Match MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
                        <AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">admin</AttributeValue>
                        <AttributeDesignator Category="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" AttributeId="http://mobi.com/ontologies/user/management#username" DataType="http://www.w3.org/2001/XMLSchema#string" MustBePresent="true"/>
                    </Match>
                </AllOf>
            </AnyOf>
        </Target>
    </Rule>
</Policy>
```

The following request is for a user that is not the admin user and is attempting to create an Ontology Record:

- Resource is `http://mobi.com/catalog-local`
- Action is `http://mobi.com/ontologies/policy#Create`
- Action Attribute for Type is `http://mobi.com/ontologies/ontology-editor#OntologyRecord`
- Subject is user with username `batman`

Let's now go through the typical XACML workflow from request to evaluation to response.

1. A REST request is made to a Mobi endpoint where the request is intercepted by the Policy Enforcement Point
 * Relevant user information is extracted from the request
 * Action and Resource information is extracted from the targeted endpoint
 ** These are defined by Java Annotations on the endpoints in the Mobi source code.
2. A XACML request is generated from the data extracted from the REST request.
3. The XACML request is then passed along to the Policy Decision Point
4. The Policy Decision Point reaches out to the Policy Information Point and Policy Retrieval Point to retrieve additional
attributes and relevant policies to evaluate against.
5. The Policy Decision Point evaluates the request against any relevant policies. In this case it is our policy listed above.
6. The Policy Decision Point sees that the User making the request is `batman` and not `admin`. Using a deny unless permit model
the Policy Decision Point returns `Deny` as the response to the request.
7. The Policy Enforcement Point propagates this `Deny` out, never actually entering the code for the REST request, and
returns a 401 Unauthorized error to the system making the REST request.

=== Mobi Policies

==== Mobi System Policies

Mobi stores default system policies in the `${karaf.etc}/policies/systemPolicies` directory. Custom XACML system policies
should be added to this directory. On initial startup these policies are loaded into the Repository and Virtual Filesystem.

WARNING: Any edits made to these policies after initial system startup will not be applied unless a `mobi:reload-system-policy` command
is run from the Karaf terminal.

==== Reload System Policy Command

A helper utility exists in the Karaf terminal for reloading manually edited system policies. The command take a path to
a system policy.

NOTE: System policy file names must be a URI Encoding of the Policy IRI.

```
karaf@mobi()> mobi:reload-system-policy --help
DESCRIPTION
        mobi:reload-system-policy

	Reloads a system policy in Mobi

SYNTAX
        mobi:reload-system-policy [PolicyFilePath]

ARGUMENTS
        PolicyFilePath
                The path to the system policy file
```

This command will replace existing system policies with the policy file provided as an argument

==== Mobi Policy Templates

Mobi makes use of policy templates for generating default policies for different Record Types. There are two main record
policy template types:

- *Record Policy*: A policy for managing the READ/DELETE/MODIFY permissions of a Record
- *Policy Policy*: A policy for managing the Record Policy and adjusting who can edit the permissions of a Record Policy

The following policy templates can be found in the `${karaf.etc}/policies/policyTemplates` directory with their system defaults:

- *datasetRecordPolicy.xml*: Default policy template for Dataset Records
    * Read Permissions: Any user with the User role
    * Delete Permissions: The user who created the Record
    * Update/Manage Permissions: The user who created the Record
    * Modify Permissions: Any user with the User role
- *mappingRecordPolicy.xml*: Default policy template for Mapping Records
    * Read Permissions: Any user with the User role
    * Delete Permissions: Any user with the User role
    * Update/Manage Permissions: The user who created the Record
    * Modify Permissions: Any user with the User role
    * Modify Master Branch: Any user with the User role
- *recordPolicy.xml*: Default policy template for Versioned RDF Records (Ontology Records and Shapes Graph Records)
    * Read Permissions: Any user with the User role
    * Delete Permissions: The user who created the Record
    * Update/Manage Permissions: The user who created the Record
    * Modify Permissions: Any user with the User role
    * Modify Master Branch: The user who created the Record
- *policyPolicy.xml*: The default policy template for managing access control for a Record. This policy is tied to each
type of Record and is associated with the Update Permission for the Record. If the User has the Update Permission, then
they can also change who else can Read/Delete/Manage/Modify a given Record.
    * Read Permissions: The user who created the Record
    * Update/Manage Permissions: The user who created the Record

These default policy templates for Records can be manually adjusted in the filesystem to reflect any organization
specific need for access control for Records. The templates use a few tokens to do string replacement on when processed
by the Mobi Record Services on creation. These tokens are:

- `%RECORDIRI%`: The IRI of the created Record
- `%USERIRI%`: The IRI of the User creating the Record
- `%POLICYIRI%`: The IRI of the Record Policy - this is used by the policyPolicy.xml for managing who can adjust
permissions for a given Record
- `%MASTER%`: The IRI of the Master branch if it is a Versioned RDF Record

NOTE: Unlike System Policies, these policies do not need to be reloaded after editing. They are picked up by the Mobi
Record Services when a user creates a new Record.