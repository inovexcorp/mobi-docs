[[mapping-tool-guide]]
=== Mapping Tool
The Mobi web-based Mapping Tool allows users to define custom, ontology-driven definitions to control and execute input data transformations to the Resource Description Framework (https://www.w3.org/RDF/[RDF]) semantic data model. User-defined mappings load semantic data into the Mobi store for analysis, sharing and linking.

To reach the Mapping Tool, click on the link in the left menu.

.Mapping Tool button
image::mapping-tool/full_mapping_tool_initial_view.png[]

To use the Mapping Tool to map data, an ontology must be in the Mobi repository, but it does not have to be opened to access it. If there are no available ontologies, you will not be able to map delimited data. To upload an ontology go to the <<ontology_editor>> and follow the steps for uploading ontologies or creating a new ontology.

The initial view of the Mapping Tool shows the Mapping Select Page which contains a searchable paginated list of the mappings within the local Mobi repository. Each mapping is displayed with a portion of its metadata along with a dropdown menu with buttons to preview, <<Duplicating a Mapping,duplicating>>, <<Editing a Mapping,editing>>, <<Running a Mapping,running>>, download, and delete the mapping. The Preview button will bring up a display of the classes and properties it maps along with the title of the source ontology. If the selected source ontology no longer exists in the local Mobi repository, you will not be able to edit, run, or duplicate the mapping. Click btn:[New Mapping] to <<Creating a Mapping,create>>. 

==== Creating a Mapping
To create a new mapping, click btn:[Create Mapping] on the Mapping Select Page. The creation overlay requires you to enter a [underline]#Title# which will populate the `dcterms:title` annotation of the new mapping record. The [underline]#Description# field populates the `dcterms:description` annotation of the new mapping record. The [underline]#Keywords# field will attach the entered values as keywords to the new mapping record.

.Create Mapping Overlay
image::mapping-tool/create_mapping_overlay.png[width=50%,pdfwidth=50%,align=center]

Clicking btn:[Submit] brings you to the File Upload Page to continue the process of creating a mapping. You must upload a delimited file to use as a standard for the mapping. You can also check whether or not the file contains a header row and select the separator character if the file is CSV. The accepted file formats are `.csv`, `.tsv`, `.xls`, and `.xlsx`. Selecting a file in the form on the left loads a preview of the first 50 rows and columns of the delimited file into the table on the right. Clicking btn:[Continue] brings you to the Edit Mapping Page.

.File Upload Page for Creating a Mapping
image::mapping-tool/file_upload_create.png[]

The Edit Mapping Page contains three tabs: Edit, Preview, and Commits. The Edit tab contains a section for displaying the currently selected source ontology, the list of class mappings, and a list of property mappings for a particular class. For every row in the delimited data, an instance of a mapped class will be made according to each class mapping. Each created class instance will have a set of properties as defined by the property mappings associated with each class mapping. The values of data properties will have assigned datatypes based on the range of the mapped data property unless otherwise specified. The Preview tab allows you to map the first 10 rows of the selected delimited file using the current state of the mapping in a variety of different RDF serializations. Just like <<ontology-editor-guide,ontologies>>, mappings are versioned with commits which can be viewed in the Commits tab.

TIP: To learn about the structure of a mapping, refer to the <<Mobi Mappings>> Appendix.

.Edit Mapping Page Edit Tab
image::mapping-tool/edit_mapping_edit.png[]

When creating a mapping, the first thing you will see is the <<Source Ontology Overlay>>. This setting can always be changed by clicking the pencil button next to the ontology name in the Edit tab. The [underline]#Class# section contains a select box with all the class mappings, a button to delete a specific class mapping, and a button to create a new class mapping. Clicking btn:[Add Class] opens an overlay where you can select a class in the imports closure of the source ontology that has not been deprecated.

The [underline]#IRI Template# section displays the template Mobi will use when generating IRIs for the created class instances from the selected class mapping. The value within the `${}` indicates what will be used for the local name of each class instance's IRI. "UUID" means that a unique identifier will be generated for each class instance. An integer means that Mobi will grab the value from the column with that index (zero-based) for each row and use each value with all white space removed as the local name for the class instance. This template can be edited by clicking the pencil button next to the section title and filling in the fields in the <<IRI Template Overlay>>.

The [underline]#Properties# section lists all the property mappings for the selected class mapping with a button to add a new property mapping. Object property mappings are displayed with the name of the class mapping whose instances will be used as the range of the property. Data or Annotation property mappings are displayed with the name of the column whose values will be used as the range of the property, a preview of what the first value would be, the datatype for the mapped value, and the language for the values if specified. Each property mapping also provides a button to edit and delete. If a data property mapping is invalid, meaning it points to a column that does not exist in the delimited file, it must be handled before the mapping can be saved or run.

Clicking btn:[Add Property] opens an overlay where you can select a property in the imports closure of the source ontology that has not been deprecated or a common annotation. The common annotations that can be mapped are `rdfs:label`, `rdfs:comment`, `dcterms:title`, and `dcterms:description`. If you select a data property or an annotation, a select box appears containing identifiers for each column in the delimited file along with a preview of the first value of the selected column. At this point, you can also specify a manual datatype override which the mapper will use over the range of the property if set. You can also specify the language for the property values by selecting `rdfs:langString` as the type and then a language select will appear underneath. If you select an object property, a select box appears containing the titles of all class mappings of the appropriate type along with an option to create a new class mapping.

.Create Property Mapping Overlay for a Data/Annotation Property
image::mapping-tool/create_property_mapping_overlay_data.png[width=50%,pdfwidth=50%,align=center]

.Create Property Mapping Overlay for an Object Property
image::mapping-tool/create_property_mapping_overlay_object.png[width=50%,pdfwidth=50%,align=center]

.Language Selection for a Data/Annotation Property
image::mapping-tool/language_selection.png[width=50%,pdfwidth=50%,align=center]

Clicking the main btn:[Save] button at the bottom of either the Edit or Preview tab saves the current state of the mapping and brings you back to the Mapping Select Page. Clicking on the arrow to the right of the btn:[Save] button provides you options for running the mapping in addition to saving it. These options are downloading the mapped data, uploading the mapped data into a data within a Mobi repository, or committing the mapped data to a specific branch of an ontology. Each option will bring up an appropriate overlay for choosing a RDF format and file name, a dataset, or an ontology and branch respectively. Clicking btn:[Submit] in an overlay will save the current state of the mapping and run it.

TIP: To learn about datasets in Mobi, refer to the <<datasets-manager-guide,Datasets Manager>>.

NOTE: For more information about running a mapping into an ontology, refer to <<Mapping into an Ontology>>.

.Options for saving and running a mapping
image::mapping-tool/save_run_options.png[]

==== Editing a Mapping
To edit a mapping, click btn:[Edit] on the Mapping Select Page. The application performs a quick check to see if the source ontology or its imported ontologies changed in such a way that the mapping is no longer valid. If this check does not pass, an overlay is displayed informing you of the error. If it passes, you are brought to the File Upload Page where you must upload a delimited file to use as a standard for the mapping. If the delimited file you choose does not contain enough columns for the mapping’s data property mappings, a list of the missing columns are displayed under the file select. However, you can still edit the mapping as long as those data properties are fixed. From there, editing the mapping works the same as <<Creating a Mapping,creating a mapping>>.

.File Upload Page for Editing a Mapping
image::mapping-tool/file_upload_edit.png[]

.File Upload Page for Editing a Mapping with missing columns
image::mapping-tool/file_upload_edit_missing_columns.png[]

==== Duplicating a Mapping
To duplicate a mapping, click btn:[Duplicate] on the Mapping Select Page. The application performs a quick check to see if the source ontology or its imported ontologies changed in such a way that the mapping is no longer valid. If this check does not pass, an overlay is displayed informing you of the error. If it passes, the Create Mapping overlay will appear allowing you to choose new values for the [underline]#Title#, [underline]#Description#, and [underline]#Keywords#. The rest of the process is the same as <<Editing a Mapping,editing a mapping>> including how missing columns are handled.

==== Running a Mapping
To run a mapping against delimited data without editing it, click btn:[Run] on the Mapping Select Page. The application performs a quick check to see if the source ontology or its imported ontologies changed in such a way that the mapping is no longer valid. If this check does not pass, an overlay is displayed informing you of the error. If it passes, you are brought to the File Upload Page where you must upload a delimited file to be used when generating RDF data. You can also check whether or not the file contains a header row and select the separator character if the file is CSV. The accepted file formats are `.csv`, `.tsv`, `.xls`, and `.xlsx`. The classes and properties that will be created using the mapping are displayed under the file select. The columns that must be present in the delimited file are highlighted in the table on the right. Selecting a file in the form on the left loads a preview of the first 50 rows and columns of the delimited file into the table. If the delimited file you choose does not contain enough columns for the mapping’s data property mappings, the properties that are missing columns turn red and you will not be able to run the mapping.

TIP: To learn about datasets in Mobi, refer to the <<datasets-manager-guide,Datasets Manager>>.

.File Upload Page for Running a Mapping
image::mapping-tool/file_upload_run.png[]

.File Upload Page for Running a Mapping with missing columns
image::mapping-tool/file_upload_run_missing_columns.png[]

Clicking btn:[Run Mapping] will provide you with options for downloading the mapped data, uploading the mapped data into a data within a Mobi repository, or committing the mapped data to a specific branch of an ontology. Each option will bring up an appropriate overlay for choosing a RDF format and file name, a dataset, or an ontology and branch respectively.

NOTE: For more information about running a mapping into an ontology, refer to <<Mapping into an Ontology>>.

.Options for saving and running a mapping
image::mapping-tool/run_options.png[]

==== Mapping Tool Reference

===== Source Ontology Overlay
The Source Ontology Overlay allows you to select the source ontology for the mapping from all uploaded ontologies in the local Mobi repository.

.Source Ontology Overlay
image::mapping-tool/source_ontology_overlay.png[width=50%,pdfwidth=50%,align=center]

The left side of the overlay contains a searchable list of all the ontologies in the local Mobi repository and a select for the version of the ontology to use. For most ontologies, this will only contain the "Latest" value. However, if an ontology was previously selected for a mapping and that ontology has changed since then, there will be an option for the "Saved" version of the ontology. The right side of the overlay displays information about the ontology from its record in the <<catalog-guide,Catalog>> and a sample of the classes in that ontology. Setting the source ontology will remove any class and property mappings in the mapping that are incompatible. Class mappings and property mappings are incompatible if the class or property that is referenced no longer exists in the imports closure of the source ontology. Property mappings are also incompatible if they are a different type or have a different range.

===== IRI Template Overlay
The IRI Template overlay provides you a way to edit each portion of the IRI template of a class mapping. The template will be used to generate the IRIs for each instance created by a class mapping.

image::mapping-tool/iri_template_overlay.png[width=50%,pdfwidth=50%,align=center]

The [underline]#Begins with# field (required) is the beginning of the IRI. This is more commonly known as the namespace. The [underline]#Then# field (required) is the next character in the IRI. This value can be thought of the separator between the namespace and local name (described below). The provided values for the [underline]#Then# field are "&#35;", "/", and ":". The [underline]#Ends with# dropdown field (required) is the last part of the IRI. This value is commonly known as the local name. The values in this dropdown are "UUID", which represents generating a unique identifier as the local name for each generated instance of each row, and the title of each column, which represents using the value of that column as the local name for each generated instance of each row. Clicking btn:[Cancel] will close the overlay. Clicking btn:[Submit] will save the IRI template.

===== Mapping into an Ontology
The overlay for mapping into an ontology contains several configurations on how the mapping result data will be committed. First, you must select the [underline]#Ontology# and [underline]#Branch# that will receive the new commit. After that, there are radio buttons that will determine how the mapping result data will be treated when the commit is made. The first option will treat all the mapping result data as new data, meaning no existing data in the ontology branch will be removed. The second option will treat all the mapping result data as changes to the existing data on the ontology branch. This means that if there are entities or properties on entities in the ontology that are not present in the mapping result data, they will be removed.

image::mapping-tool/map_into_ontology.png[width=50%,pdfwidth=50%,align=center]

A sample workflow using this tool would be to create an ontology in the <<ontology-editor-guide,Ontology Editor>> and create a branch that will received all mapped data commits. Then run your mapping from the Mapping Tool, committing to the new branch as additions. Finally in the Ontology Editor, merge that branch with the mapped data commit into the MASTER branch. Then any subsequent runs of the mapping with updated data would be committed as changes to the mapped data branch and merged into the MASTER branch.